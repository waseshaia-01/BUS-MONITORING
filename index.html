<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bus QR Scanner</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:16px}
    header,footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .frame{width:2in;height:2in;border:3px dashed #333;border-radius:12px;margin:12px auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    select,button{padding:8px 12px;font-size:16px}
    #status{margin-top:8px;min-height:24px}
    #reader{max-width:520px;margin:12px auto}
    a.btn{display:inline-block;text-decoration:none;background:#0b5cff;color:#fff;padding:8px 12px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <h1>Bus QR Scanner</h1>
    <a class="btn" href="dashboard.html">View Dashboard</a>
  </header>

  <div class="row">
    <label for="bus">Select Bus:</label>
    <select id="bus">
      <option>Bus 1</option><option>Bus 2</option><option>Bus 3</option><option>Bus 4</option>
      <option>Bus 5</option><option>Bus 6</option><option>Bus 7</option><option>Bus 8</option>
      <option>Bus 9</option><option>Bus 10</option><option>Bus 11</option><option>Bus 12</option>
    </select>
    <button id="start">Start Camera</button>
    <button id="stop">Stop</button>
  </div>

  <div class="frame" title="2×2 inches QR frame"></div>
  <div id="reader"></div>
  <div id="status"></div>

  <!-- Libraries (CDN) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- Firebase (ESM modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
      enableIndexedDbPersistence, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 1) TODO: paste YOUR config from Firebase console
    const firebaseConfig = {
      apiKey: "AIzaSyAjypFIncOMzfG_lgAELrDTnrJ_2-ZWuFA",
      authDomain: "bus-scanner-50fe9.firebaseapp.com",
      projectId: "bus-scanner-50fe9",
      storageBucket: "bus-scanner-50fe9.firebasestorage.app",
      messagingSenderId: "552524740644",
      appId: "1:552524740644:web:3cdb346ae7d9b2850d80b1"
    };

    // 2) Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // (Optional) Offline cache so it still works without internet
    enableIndexedDbPersistence(db).catch(() => { /* ignore multi-tab errors */ });

    // 3) HTML elements
    const statusEl = document.getElementById('status');
    const busEl    = document.getElementById('bus');
    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');
    const readerId = "reader";
    let html5QrCode = null;

    function show(msg){ statusEl.textContent = msg; }

    // 4) Start scanner
    startBtn.addEventListener('click', async () => {
      try{
        if(!html5QrCode){
          html5QrCode = new Html5Qrcode(readerId);
        }
        const cameras = await Html5Qrcode.getCameras();
        const camId = cameras?.[0]?.id;
        if(!camId){ show("No camera found"); return; }

        await html5QrCode.start(
          { deviceId: { exact: camId } },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          (err) => {}
        );
        show("Scanner started. Point a QR to the frame.");
      }catch(e){ show("Camera error: " + e); }
    });

    // 5) Stop scanner
    stopBtn.addEventListener('click', async () => {
      try{
        await html5QrCode?.stop(); await html5QrCode?.clear();
        show("Scanner stopped.");
      }catch(e){ show("Stop error: " + e); }
    });

    // 6) When QR is read
    async function onScanSuccess(decodedText){
      const busName = busEl.value;      // e.g., "Bus 1"
      const code    = decodedText.trim(); // we expect QR contains the attendee "Code"
      show(`Scanned: ${code} | Checking ${busName}...`);

      // Firestore path design:
      // buses/{busId}/attendees/{code}
      const busId = busName.toLowerCase().replace(" ", "-"); // "bus-1"
      const attendeeRef = doc(db, `buses/${busId}/attendees/${code}`);

      const snap = await getDoc(attendeeRef);
      if(!snap.exists()){
        show("❌ Not found in this bus list.");
        return;
      }

      const data = snap.data();
      if(data.scanned){
        show(`⚠️ Already scanned at ${data.scannedAt?.toDate?.() || data.scannedAt}`);
        return;
      }

      await updateDoc(attendeeRef, { scanned: true, scannedAt: serverTimestamp() });
      show("✅ Marked as scanned.");
    }
  </script>
</body>
</html>
