<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bus Scanner Dashboard</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{border:1px solid #ccc;border-radius:12px;padding:12px;cursor:pointer;transition:background 0.3s}
    .card.active{background:#e8f0ff;border-color:#0b5cff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .accordion-content{
      grid-column: 1 / -1;
      overflow:hidden;
      max-height:0;
      transition:max-height 0.6s ease;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0 8px;
    }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    td,th{border-bottom:1px solid #eee;padding:6px;text-align:left}
    button,a.btn{padding:8px 12px;border-radius:8px;border:1px solid #999;background:#f5f5f5;text-decoration:none}
    .note{font-size:13px;color:#555}
  </style>
</head>
<body>
  <header class="row">
    <h1>Dashboard</h1>
    <a class="btn" href="index.html">⬅ Back to Scanner</a>
  </header>

  <section class="row">
    <button id="download-template">Download Template (Excel)</button>
    <input type="file" id="upload" accept=".xlsx,.xls,.csv"/>
    <select id="bus">
      <option>Bus 1</option><option>Bus 2</option><option>Bus 3</option><option>Bus 4</option>
      <option>Bus 5</option><option>Bus 6</option><option>Bus 7</option><option>Bus 8</option>
      <option>Bus 9</option><option>Bus 10</option><option>Bus 11</option><option>Bus 12</option>
    </select>
    <button id="import">Upload Attendees to Selected Bus</button>
  </section>

  <p class="note">Tip: The Excel file must have columns: <b>Code</b>, <b>Name</b>.</p>

  <h2>Bus Summary</h2>
  <div id="bus-grid" class="grid"></div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, setDoc, doc, collection, getDocs, onSnapshot, deleteDoc,
    query, where, enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyAjypFIncOMzfG_lgAELrDTnrJ_2-ZWuFA",
    authDomain: "bus-scanner-50fe9.firebaseapp.com",
    projectId: "bus-scanner-50fe9",
    storageBucket: "bus-scanner-50fe9.firebasestorage.app",
    messagingSenderId: "552524740644",
    appId: "1:552524740644:web:3cdb346ae7d9b2850d80b1"
  };
  const app = initializeApp(firebaseConfig); 
  const db  = getFirestore(app);
  enableIndexedDbPersistence(db).catch(()=>{});

  let expandedBusId = null;
  
  // Variables
  const buses = Array.from({length:12}, (_,i)=>`bus-${i+1}`);
  const busNames = id => `Bus ${id.split('-')[1]}`;
  const grid = document.getElementById('bus-grid');

  // Render summary
  async function renderSummary(){
    grid.innerHTML = "";
    for(const id of buses){
      const colRef = collection(db, `buses/${id}/attendees`);
      const qSnap  = await getDocs(query(colRef, where("scanned", "==", true)));
      const count  = qSnap.size;

      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.id = id; // final format stored
      card.innerHTML = `<h3>${busNames(id)}</h3><p>Scanned: <b>${count}</b></p>`;
      grid.appendChild(card);
    }
  }

  // Render expanded bus section
  async function renderBusSection(id, container){
    container.innerHTML = `
      <div class="row" style="padding:8px 0;">
        <button data-id="${id}" class="gen-pdf">QR Code Download (A4 · 6 per page)</button>
        <button data-id="${id}" class="del-all">Delete All</button>
      </div>
      <table>
        <thead><tr><th>Code</th><th>Name</th><th>Scanned At</th><th></th></tr></thead>
        <tbody id="tbody-${id}"></tbody>
      </table>
    `;
    const tbody = container.querySelector(`#tbody-${id}`);
    const colRef = collection(db, `buses/${id}/attendees`);
    onSnapshot(colRef, snap=>{
      tbody.innerHTML = "";
      snap.forEach(docu=>{
        const d = docu.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${docu.id}</td>
          <td>${d.name||""}</td>
          <td>${d.scannedAt?.toDate?.()?.toLocaleString?.() || ""}</td>
          <td><button class="del" data-id="${id}" data-code="${docu.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  // Accordion behavior
  grid.addEventListener('click', async (e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    const id = card.dataset.id; // already in correct format
    const isActive = card.classList.contains('active');

    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.accordion-content').forEach(sec=>{
      sec.style.maxHeight = null;
      sec.addEventListener('transitionend',()=>sec.remove(),{once:true});
    });

    if(!isActive){
      expandedBusId = id;
      card.classList.add('active');
      const content = document.createElement('div');
      content.className = 'accordion-content';
      content.innerHTML = `<p style="padding:8px;color:#777">Loading...</p>`;
      card.insertAdjacentElement('afterend', content);

      await renderBusSection(id, content);
      requestAnimationFrame(()=>{
        content.style.maxHeight = content.scrollHeight + "px";
      });
    } else {
      expandedBusId = null;
    }
  });

  // Section buttons
  grid.addEventListener('click', async (e)=>{
    if(e.target.matches('.del')){
      const id = e.target.dataset.id;
      const code = e.target.dataset.code;
      await deleteDoc(doc(db, `buses/${id}/attendees/${code}`));
    }
    if(e.target.matches('.del-all')){
      const id = e.target.dataset.id;
      if(!confirm("Delete ALL attendees in this bus?")) return;
      const colRef = collection(db, `buses/${id}/attendees`);
      const snap = await getDocs(colRef);
      const deletions = [];
      snap.forEach(d=>deletions.push(deleteDoc(d.ref)));
      await Promise.all(deletions);
      await renderSummary();
    }
    if(e.target.matches('.gen-pdf')){
      generatePassPDF(e.target.dataset.id);
    }
  });

  // Download Template
  document.getElementById('download-template').addEventListener('click', ()=>{
    const ws = XLSX.utils.aoa_to_sheet([["Code","Name"]]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "Attendees_Template.xlsx");
  });

  // Upload attendees
  document.getElementById('import').addEventListener('click', async () => {
    const file = document.getElementById('upload').files[0];
    const selectedBus = document.getElementById('bus').value;
    const busId = selectedBus.trim().toLowerCase().replace(/\s+/g, "-"); // one-time conversion

    if (!file) {
      alert("Please select a file first.");
      return;
    }

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    for (const row of json) {
      if (row.Code && row.Name) {
        await setDoc(doc(db, `buses/${busId}/attendees/${row.Code}`), {
          name: row.Name,
          scanned: false
        });
      }
    }

    alert(`Attendees uploaded successfully to ${selectedBus}`);
    await renderSummary();

    // Refresh table if this bus is open
    if (expandedBusId === busId) {
      const accordion = document.querySelector(`#tbody-${busId}`)?.closest(".accordion-content");
      if (accordion) {
        await renderBusSection(busId, accordion);
        accordion.style.maxHeight = accordion.scrollHeight + "px";
      }
    }
  });

  // QR generator
  function makeQrPng(text){
    return new Promise((resolve)=>{
      const typeNumber = 8;
      const qr = qrcode(typeNumber, 'H');
      qr.addData(String(text));
      qr.make();
      const size = 256;
      const cell = Math.floor(size / qr.getModuleCount());
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle="#fff"; ctx.fillRect(0,0,size,size);
      ctx.fillStyle="#000";
      const count = qr.getModuleCount();
      for(let r=0;r<count;r++){
        for(let c=0;c<count;c++){
          if(qr.isDark(r,c)){
            ctx.fillRect(c*cell, r*cell, cell, cell);
          }
        }
      }
      resolve(canvas.toDataURL("image/png"));
    });
  }

  // PDF generator
  async function generatePassPDF(busId){
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF({ unit: "mm", format: "a4" });
    const colRef = collection(db, `buses/${busId}/attendees`);
    const snap = await getDocs(colRef);
    const data = [];
    snap.forEach(d=>data.push({ code: d.id, ...d.data() }));

    const cardW = 50, cardH = 100, qr = 45, marginX = 15, marginY = 10, gapX = 20, gapY = 10;
    let i = 0;
    for(const row of data){
      if(i>0 && i % 6 === 0) docPDF.addPage();
      const slot = i % 6;
      const col = slot % 2;
      const r   = Math.floor(slot / 2);
      const x = marginX + col*(cardW + gapX);
      const y = marginY + r*(cardH + gapY);
      docPDF.rect(x, y, cardW, cardH);
      docPDF.setFont("times","bold"); docPDF.setFontSize(10);
      docPDF.text("TSUNETETSU CEBU INC.", x+2, y+6);
      const qrPng = await makeQrPng(row.code);
      docPDF.addImage(qrPng, "PNG", x + (cardW-qr)/2, y+10, qr, qr);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(10);
      docPDF.text((row.name||"").toUpperCase(), x+2, y+10+qr+8);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(12);
      docPDF.text("EVENT", x+2, y+10+qr+18);
      docPDF.setFont("helvetica","normal"); docPDF.setFontSize(12);
      docPDF.text("TCI Family Day 2025", x+2, y+10+qr+24);
      docPDF.text("September 7, 2025 | 8:00 AM – 4:00 PM", x+2, y+10+qr+30);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(12);
      docPDF.text("VENUE", x+2, y+10+qr+40);
      docPDF.setFont("helvetica","normal"); docPDF.setFontSize(12);
      docPDF.text("Hidden Valley Mountain and Wavepool Resort", x+2, y+10+qr+46, { maxWidth: cardW-4 });
      docPDF.text("Pinamungahan, Cebu", x+2, y+10+qr+52);
      const busLabel = busNames(busId);
      docPDF.setFont("helvetica","bold"); docPDF.setFontSize(12);
      docPDF.text("EVENT PASS", x+2, y+cardH-10);
      docPDF.text(`B (${busLabel})`, x+cardW-2, y+cardH-10, { align: "right" });
      i++;
    }
    docPDF.save(`${busNames(busId).replace(" ","_")}_Event_Passes.pdf`);
  }

  renderSummary();
  </script>
</body>
</html>
